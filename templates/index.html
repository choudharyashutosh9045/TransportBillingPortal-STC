<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Multi-Transport Billing Portal</title>
  <style>
    :root{
      --bg:#0a0f1e;
      --panel:#0f172a;
      --card:rgba(255,255,255,.04);
      --border:rgba(255,255,255,.12);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#10b981;
      --accent2:#3b82f6;
      --accent3:#f59e0b;
      --shadow: 0 20px 60px rgba(0,0,0,.50);
      --radius:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 15% 0%, rgba(59,130,246,.16), transparent 55%),
        radial-gradient(1000px 550px at 85% 10%, rgba(16,185,129,.14), transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      background-attachment: fixed;
    }
    .layout{
      display:grid;
      grid-template-columns: 300px 1fr;
      min-height:100vh;
    }
    .sidebar{
      padding:24px 20px;
      border-right:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 70%);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;
      gap:14px;
      align-items:center;
      padding:16px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(59,130,246,.08), rgba(16,185,129,.08));
      box-shadow: var(--shadow);
    }
    .brandIcon{
      width:52px;height:52px;border-radius:16px;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:20px;
      color:#fff;
      letter-spacing:.5px;
      box-shadow: 0 8px 24px rgba(16,185,129,.25);
    }
    .brand h1{font-size:15px;margin:0;line-height:1.3;font-weight:700;}
    .brand p{margin:4px 0 0 0;font-size:12px;color:var(--muted);}
    .nav{margin-top:20px;display:flex;flex-direction:column;gap:8px;}
    .nav a{
      text-decoration:none;color:var(--text);
      padding:13px 16px;border-radius:14px;
      border:1px solid transparent;
      background: rgba(255,255,255,.03);
      display:flex;align-items:center;gap:12px;
      transition:.2s;font-size:14px;font-weight:500;
    }
    .nav a:hover{
      transform: translateX(4px);
      background: rgba(255,255,255,.06);
      border-color: var(--border);
    }
    .nav a.active{
      background: linear-gradient(135deg, rgba(59,130,246,.12), rgba(16,185,129,.12));
      border-color: rgba(16,185,129,.3);
    }
    .chip{
      margin-left:auto;font-size:10px;padding:4px 10px;border-radius:999px;
      border:1px solid rgba(16,185,129,.3);
      background: rgba(16,185,129,.15);
      color:var(--accent);font-weight:700;
    }
    .chipOrange{
      margin-left:auto;font-size:10px;padding:4px 10px;border-radius:999px;
      border:1px solid rgba(245,158,11,.4);
      background: rgba(245,158,11,.15);
      color:var(--accent3);font-weight:700;
    }
    .sideFooter{
      margin-top:20px;padding:16px;border-radius: var(--radius);
      border:1px solid var(--border);background: rgba(15,23,42,.50);
      color:var(--muted);font-size:12px;line-height:1.5;
    }

    .main{padding:28px 32px;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:20px;margin-bottom:24px;
    }
    .title h2{margin:0;font-size:26px;letter-spacing:-.3px;font-weight:700;}
    .title p{margin:8px 0 0 0;color:var(--muted);font-size:14px;}

    .topRight{
      display:flex;
      align-items:center;
      gap:14px;
    }

    .search{
      display:flex;
      align-items:center;
      gap:12px;
      padding:11px 16px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      min-width:350px;
      transition:.2s;
    }
    .search:focus-within{
      border-color: var(--accent2);
      box-shadow: 0 0 0 3px rgba(59,130,246,.15);
    }
    .search input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
    }
    .profile{
      width:44px;height:44px;border-radius:16px;
      border:1px solid var(--border);
      background: linear-gradient(135deg, rgba(59,130,246,.2), rgba(16,185,129,.2));
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:16px;
      color:var(--text);
    }

    .grid{display:grid;grid-template-columns: 1.3fr .7fr;gap:24px;}
    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .cardHead{padding:20px 22px;}
    .cardHead h3{margin:0;font-size:17px;letter-spacing:-.2px;font-weight:700;}
    .cardHead p{margin:6px 0 0 0;font-size:13px;color:var(--muted);line-height:1.5;}
    .cardBody{padding:0 22px 22px 22px;}

    .btn{
      cursor:pointer;border:none;border-radius:14px;padding:13px 20px;
      font-weight:700;color:#fff;font-size:14px;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      transition:.2s;
      box-shadow: 0 8px 24px rgba(16,185,129,.2);
    }
    .btn:hover{transform: translateY(-2px);box-shadow: 0 12px 32px rgba(16,185,129,.3);}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}
    .btn2{
      cursor:pointer;border:1px solid var(--border);border-radius:14px;padding:13px 20px;
      font-weight:700;color:var(--text);background: rgba(255,255,255,.04);transition:.2s;
      font-size:14px;
    }
    .btn2:hover{background: rgba(255,255,255,.08);transform: translateY(-1px);}

    .drop{
      border:2px dashed rgba(59,130,246,.4);
      border-radius: var(--radius);
      padding:24px;
      background: rgba(15,23,42,.60);
      transition:.3s;
    }
    .drop.drag{
      border-color: rgba(16,185,129,.7);
      background: rgba(16,185,129,.1);
      transform: scale(1.01);
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;}
    .uploadTitle{font-weight:800;font-size:15px;}
    .hint{margin-top:8px;color:var(--muted);font-size:13px;line-height:1.5;}
    .btns{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    input[type=file]{display:none;}
    .fileName{
      margin-top:12px;font-size:13px;color:var(--muted);
      padding:10px 14px;background:rgba(255,255,255,.04);
      border-radius:10px;border:1px solid var(--border);
    }

    /* Company Selector */
    .companySelector{
      margin-top:18px;
      padding:16px;
      background: linear-gradient(135deg, rgba(59,130,246,.08), rgba(16,185,129,.08));
      border:1px solid var(--border);
      border-radius:16px;
    }
    .companyLabel{
      font-size:12px;
      color:var(--muted);
      margin-bottom:10px;
      font-weight:600;
    }
    select{
      width:100%;
      padding:12px 16px;
      background: rgba(15,23,42,.80);
      border:1px solid var(--border);
      border-radius:12px;
      color:var(--text);
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:.2s;
    }
    select:hover{
      background: rgba(15,23,42,.95);
      border-color: var(--accent2);
    }
    select:focus{
      outline:none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(16,185,129,.15);
    }
    option{
      background: rgba(15,23,42,1);
      padding:10px;
    }

    .stats{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:18px;}
    .stat{
      padding:16px;border-radius:16px;border:1px solid var(--border);
      background: linear-gradient(135deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    }
    .stat .k{color:var(--muted);font-size:12px;font-weight:500;}
    .stat .v{font-size:22px;font-weight:800;margin-top:8px;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .mono{
      font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size:12px;color:rgba(229,231,235,.92);
      white-space:pre-wrap;line-height:1.6;
      background: rgba(15,23,42,.60);
      border:1px solid var(--border);
      padding:16px;border-radius:14px;
    }

    .tableWrap{
      margin-top:16px;
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      background: rgba(15,23,42,.60);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th, td{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      color:rgba(229,231,235,.92);
      text-align:left;
      vertical-align:top;
    }
    th{
      font-size:12px;font-weight:700;
      color:var(--muted);
      background: rgba(255,255,255,.04);
    }
    tr:hover{background: rgba(255,255,255,.02);}
    .miniNote{margin-top:14px;color:var(--muted);font-size:13px;line-height:1.6;}
    .toast{
      margin-top:14px;padding:14px 18px;border-radius:14px;
      border:1px solid rgba(16,185,129,.4);
      background: rgba(16,185,129,.12);
      color: rgba(229,231,235,.95);
      font-size:13px;display:none;font-weight:500;
    }

    .historyItem{
      padding:14px;border-radius:12px;border:1px solid var(--border);
      background: rgba(255,255,255,.03);margin-bottom:10px;
      transition:.2s;cursor:pointer;
    }
    .historyItem:hover{
      background: rgba(255,255,255,.06);
      transform: translateX(4px);
    }
    .histTime{font-size:11px;color:var(--muted);margin-bottom:6px;}
    .histFile{font-size:13px;font-weight:700;margin-bottom:4px;}
    .histDetails{font-size:12px;color:var(--muted);}
    .histCompany{
      display:inline-block;
      font-size:11px;padding:4px 10px;border-radius:8px;
      background: rgba(16,185,129,.15);color:var(--accent);
      border:1px solid rgba(16,185,129,.3);
      margin-top:6px;
      font-weight:700;
    }
    .histCompany.transin{
      background: rgba(245,158,11,.15);color:var(--accent3);
      border:1px solid rgba(245,158,11,.4);
    }
    .histBills{
      margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;
    }
    .billChip{
      font-size:11px;padding:4px 10px;border-radius:8px;
      background: rgba(59,130,246,.15);color:var(--accent2);
      border:1px solid rgba(59,130,246,.3);
      cursor:pointer;transition:.2s;
    }
    .billChip:hover{
      background: rgba(59,130,246,.25);
      transform: translateY(-1px);
    }

    @media (max-width: 1100px){
      .layout{grid-template-columns:1fr;}
      .sidebar{display:none;}
      .grid{grid-template-columns:1fr;}
      .search{min-width:100%;}
    }

    .emptyState{
      text-align:center;padding:40px 20px;color:var(--muted);
    }
  </style>
</head>

<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <div class="brandIcon">MT</div>
        <div>
          <h1>Multi-Transport Portal</h1>
          <p>2 Companies ‚Ä¢ Excel ‚Üí PDF</p>
        </div>
      </div>

      <nav class="nav">
        <a href="#" class="active"><span>üìÑ</span> Generate Bills <span class="chip">LIVE</span></a>
        <a href="#" id="downloadTemplateLink"><span>üì•</span> Download Template</a>
        <a href="#recent" onclick="scrollToRecent(event)"><span>üßæ</span> Recent Bills</a>
        <a href="#"><span>‚öôÔ∏è</span> Settings</a>
      </nav>

      <div class="sideFooter">
        <b>System:</b> Multi-Transport Billing<br/>
        <b>Companies:</b> 2 Active (STC, Transin)<br/>
        <b>Mode:</b> GST ‚Ä¢ Non-GST
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title">
          <h2>Multi-Transport Dashboard</h2>
          <p>Select company ‚Üí upload Excel ‚Üí generate professional PDF invoices.</p>
        </div>

        <div class="topRight">
          <div class="search">
            üîé <input id="search" placeholder="Search LR / Truck / Invoice No..." />
          </div>
          <div class="profile">MT</div>
        </div>
      </div>

      <div class="grid">
        <!-- LEFT: Upload -->
        <section class="card">
          <div class="cardHead">
            <h3>üì§ Upload & Generate Bills</h3>
            <p>Choose transport company ‚Üí upload Excel ‚Üí generate Bills.zip</p>
          </div>

          <div class="cardBody">
            <!-- Company Selector (STC + Transin only) -->
            <div class="companySelector">
              <div class="companyLabel">üè¢ SELECT TRANSPORT COMPANY</div>
              <select id="companySelect">
                <option value="stc">SOUTH TRANSPORT COMPANY (STC)</option>
                <option value="transin">TRANSIN LOGISTICS PVT LTD</option>
              </select>
            </div>

            <form id="form" action="/" method="POST" enctype="multipart/form-data">
              <input type="hidden" id="companyInput" name="company" value="stc" />
              
              <div id="drop" class="drop" style="margin-top:18px;">
                <div class="row">
                  <div>
                    <div class="uploadTitle">üìå Drag & Drop Excel File</div>
                    <div class="hint">Or click "Choose File". Download template first for correct format.</div>
                  </div>

                  <div class="btns">
                    <label class="btn2" for="fileInput">Choose File</label>
                    <button id="previewBtn" class="btn2" type="button" disabled>üëÅÔ∏è Preview</button>
                    <button id="genBtn" class="btn" type="submit" disabled>‚ö° Generate Bills</button>
                  </div>
                </div>

                <div id="fileName" class="fileName">üìÇ No file selected</div>
              </div>

              <input id="fileInput" name="file" type="file" accept=".xlsx,.xls" />
            </form>

            <div class="stats">
              <div class="stat">
                <div class="k">Selected Company</div>
                <div id="selectedCompany" class="v">STC</div>
              </div>
              <div class="stat">
                <div class="k">Rows Detected</div>
                <div id="rowsCount" class="v">0</div>
              </div>
            </div>

            <div id="toast" class="toast">
              ‚úÖ File ready. Generating PDFs... Please wait.
            </div>

            <div class="miniNote">
              ‚úî Each company has unique format & bank details<br/>
              ‚úî <b>Transin:</b> No DateArrival/DateDelivery/TruckType needed. Multiple InvoiceNos per row supported (use Alt+Enter in Excel).<br/>
              ‚úî <b>STC:</b> Full format with all fields
            </div>

            <div id="previewArea" style="display:none;">
              <div class="miniNote" style="margin-top:18px;">
                <b>üìä Preview Data (Search to filter)</b>
              </div>

              <div class="tableWrap">
                <table>
                  <thead>
                    <tr>
                      <th>FreightBillNo</th>
                      <th>LRNo</th>
                      <th>TruckNo</th>
                      <th>InvoiceNo</th>
                      <th>Destination</th>
                      <th>TotalAmount</th>
                    </tr>
                  </thead>
                  <tbody id="previewTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- RIGHT: Recent + Excel format -->
        <section class="card">
          <div class="cardHead">
            <h3 id="recent">üïí Recent Generated Bills</h3>
            <p>Last 20 uploads - click bill chips to download PDFs</p>
          </div>
          <div class="cardBody">
            <div id="history"></div>

            <div class="miniNote" style="margin-top:20px;">
              <b>üìã Excel Format Notes</b>
            </div>
            <div class="mono" style="margin-top:12px;"><b>Transin Format (Simplified):</b>
FreightBillNo, InvoiceDate, DueDate, FromLocation, ShipmentDate,
LRNo, Destination, CNNumber, TruckNo, InvoiceNo, Pkgs, WeightKgs,
FreightAmt, ToPointCharges, UnloadingCharge, SourceDetention,
DestinationDetention

<b>STC Format (Full):</b>
+ DateArrival, DateDelivery, TruckType</div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const fileName = document.getElementById("fileName");
    const genBtn = document.getElementById("genBtn");
    const previewBtn = document.getElementById("previewBtn");
    const drop = document.getElementById("drop");
    const toast = document.getElementById("toast");
    const rowsCount = document.getElementById("rowsCount");
    const previewArea = document.getElementById("previewArea");
    const previewTable = document.getElementById("previewTable");
    const historyBox = document.getElementById("history");
    const searchInput = document.getElementById("search");
    const companySelect = document.getElementById("companySelect");
    const companyInput = document.getElementById("companyInput");
    const selectedCompanyDisplay = document.getElementById("selectedCompany");
    const downloadTemplateLink = document.getElementById("downloadTemplateLink");

    let allPreviewRows = [];
    let currentCompany = "stc";

    // Company selector change
    companySelect.addEventListener("change", function(){
      currentCompany = companySelect.value;
      const selected = companySelect.value.toUpperCase();
      companyInput.value = companySelect.value;
      selectedCompanyDisplay.textContent = selected === "TRANSIN" ? "TRANSIN" : selected;
      updateTemplateLink();
      console.log("Company changed to:", selected);
    });

    function updateTemplateLink(){
      downloadTemplateLink.href = `/download-template?company=${currentCompany}`;
    }
    updateTemplateLink();

    function setFileName(){
      if(fileInput.files && fileInput.files.length > 0){
        fileName.innerHTML = `‚úÖ Selected: <b>${fileInput.files[0].name}</b>`;
        genBtn.disabled = false;
        previewBtn.disabled = false;
        console.log("File selected:", fileInput.files[0].name);
      } else {
        fileName.innerHTML = "üìÇ No file selected";
        genBtn.disabled = true;
        previewBtn.disabled = true;
      }
    }

    fileInput.addEventListener("change", setFileName);

    document.getElementById("form").addEventListener("submit", function(e){
      if(!fileInput.files || fileInput.files.length === 0){
        e.preventDefault();
        alert("Please select a file first!");
        return false;
      }
      console.log("Form submitting with file:", fileInput.files[0].name);
      console.log("Company:", companyInput.value);
      toast.style.display = "block";
      genBtn.disabled = true;
      genBtn.textContent = "‚è≥ Generating...";
    });

    // Drag-drop
    ["dragenter","dragover"].forEach(ev=>{
      drop.addEventListener(ev, e=>{
        e.preventDefault();
        e.stopPropagation();
        drop.classList.add("drag");
      });
    });

    ["dragleave","drop"].forEach(ev=>{
      drop.addEventListener(ev, e=>{
        e.preventDefault();
        e.stopPropagation();
        drop.classList.remove("drag");
      });
    });

    drop.addEventListener("drop", (e)=>{
      const files = e.dataTransfer.files;
      if(files && files.length > 0){
        fileInput.files = files;
        setFileName();
      }
    });

    // Load history
    async function loadHistory(){
      try{
        const res = await fetch("/api/history");
        const data = await res.json();

        if(!data || data.length === 0){
          historyBox.innerHTML = '<div class="emptyState">üì≠<br/>No history yet. Generate your first bill!</div>';
          return;
        }

        let html = "";
        data.forEach((h, i)=>{
          const companyCode = h.company_code || 'stc';
          const companyClass = companyCode === 'transin' ? 'transin' : '';

          html += `
            <div class="historyItem">
              <div class="histTime">${h.time}</div>
              <div class="histFile">üìÑ ${h.file}</div>
              <div class="histCompany ${companyClass}">${h.company || 'STC'}</div>
              <div class="histDetails">Rows: ${h.rows} | Bills: ${h.bills ? h.bills.length : 0}</div>
              ${h.bills && h.bills.length > 0 ? `
                <div class="histBills">
                  ${h.bills.map(b => `<span class="billChip" onclick="downloadBill('${companyCode}_${b.replace(/\//g, '_')}.pdf')">${b}</span>`).join('')}
                </div>
              ` : ''}
            </div>
          `;
        });
        historyBox.innerHTML = html;
      }catch(e){
        historyBox.innerHTML = '<div class="emptyState">‚ùå History load failed</div>';
        console.error(e);
      }
    }
    loadHistory();

    function downloadBill(filename){
      window.location.href = `/api/bills/${filename}`;
    }

    function scrollToRecent(e){
      e.preventDefault();
      document.getElementById('recent').scrollIntoView({behavior: 'smooth'});
    }

    // Preview
    previewBtn.addEventListener("click", async ()=>{
      if(!fileInput.files || fileInput.files.length === 0) return;

      previewBtn.disabled = true;
      previewBtn.textContent = "‚è≥ Loading...";

      const fd = new FormData();
      fd.append("file", fileInput.files[0]);

      try{
        const res = await fetch("/preview", { method:"POST", body: fd });
        const data = await res.json();

        if(!data.ok){
          alert(data.error || "Preview failed");
          previewBtn.disabled = false;
          previewBtn.textContent = "üëÅÔ∏è Preview";
          return;
        }

        rowsCount.textContent = data.count;
        allPreviewRows = data.rows || [];
        renderPreview(allPreviewRows);
        previewArea.style.display = "block";
      }catch(e){
        alert("Preview error: " + e.message);
        console.error(e);
      }finally{
        previewBtn.disabled = false;
        previewBtn.textContent = "üëÅÔ∏è Preview";
      }
    });

    function renderPreview(rows){
      if(!rows || rows.length === 0){
        previewTable.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);">No matching rows found</td></tr>';
        return;
      }
      previewTable.innerHTML = "";
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><b>${r.FreightBillNo || ""}</b></td>
          <td>${r.LRNo || ""}</td>
          <td>${r.TruckNo || ""}</td>
          <td>${r.InvoiceNo || ""}</td>
          <td>${r.Destination || ""}</td>
          <td style="color:var(--accent);font-weight:700;">${r.TotalAmount || ""}</td>
        `;
        previewTable.appendChild(tr);
      });
    }

    // Search filter
    searchInput.addEventListener("input", ()=>{
      const q = (searchInput.value || "").toLowerCase().trim();
      if(!q){
        renderPreview(allPreviewRows);
        return;
      }
      const filtered = allPreviewRows.filter(r=>{
        return (
          String(r.FreightBillNo || "").toLowerCase().includes(q) ||
          String(r.LRNo || "").toLowerCase().includes(q) ||
          String(r.TruckNo || "").toLowerCase().includes(q) ||
          String(r.InvoiceNo || "").toLowerCase().includes(q) ||
          String(r.Destination || "").toLowerCase().includes(q)
        );
      });
      renderPreview(filtered);
    });
  </script>
</body>
</html>